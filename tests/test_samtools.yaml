# /!\ Before run bellow tests, isolate 'view' task in 'temp.wdl' file
# /!\ Special tests require to be run with 'pytest --basetemp=/tmp'

- name: Samtools view solo
  tags:
    - task_level
    - view
  # Takes 5-6 min to run
  command: miniwdl run -d out-miniwdl/. --no-cache --verbose --no-quant-check --cfg tests/sing.cfg --input tests/samtools/solo_inputs.json --task view temp.wdl
  files:
    - path: out-miniwdl/out/outputFile/A161161.bam
      should_exist: true
      # ENH: Better checksum 'BAM without header' (using 'special_files' functions)
      #      -> Should be identical to 'bwa2' one
      # md5sum:  Instead use 'bwa mem special' bellow

- name: Samtools view solo special files
  # Checksum BAM without its header
  tags:
    - task_level
    - view
    - special
  command: nohup bash tests/samtools/run_special.sh /tmp/Samtools_view_solo/out-miniwdl/out
  files:
    - path: out-test/bam.md5
      should_exist: true
      md5sum: 49e8b174f1a851fc074667b7770a1768

- name: Samtools view CRAM solo
  tags:
    - task_level
    - cram
  # Takes 5-6 min to run
  command: miniwdl run -d out-miniwdl/. --no-cache --verbose --no-quant-check --cfg tests/sing.cfg --input tests/samtools/solo-CRAM_inputs.json --task view temp.wdl
  files:
    - path: out-miniwdl/out/outputFile/A161161.cram
      should_exist: true
      # ENH: Better checksum 'BAM without header' (using 'special_files' functions)
      #      -> Should be identical to 'bwa2' one
      # md5sum:  Instead use 'bwa mem special' bellow

- name: Samtools view CRAM solo special files
  # Checksum BAM without its header
  tags:
    - task_level
    - cram
    - special
  command: nohup bash tests/samtools/run_special.sh /tmp/Samtools_view_CRAM_solo/out-miniwdl/out
  files:
    - path: out-test/bam.md5
      should_exist: true
      # MEMO: Checksum differ from above, but only due to filename extension (.cram vs .bam)
      #       -> BAM/CRAM content is the same = cd164b4b46c2a70211fa61f2418b19be
      md5sum: b619da5c56333d224e3f55d1f2f2a185
